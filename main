import datetime
import random
import telebot
from telebot import types
from pycoingecko import CoinGeckoAPI
from py_currency_converter import convert
import time
cg = CoinGeckoAPI()
global ID
ID = 5434586176

global button
button = types.ReplyKeyboardMarkup(resize_keyboard=True)

bot = telebot.TeleBot('6105008054:AAHnVQ123BM2VtO86PJ9IW5pmDT-mfhO6wA')
@bot.message_handler(commands=["start1"])

def captcha(message):
    global a, b
    a, b = random.randint(1,11), random.randint(1,11)
    msg = bot.send_message(message.chat.id, f'Ð ÐµÑˆÐ¸Ñ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€: {a} + {b} = ?')
    bot.register_next_step_handler(msg, captcha2)
def captcha2(message):
    i = a + b
    if message.text == str(i):
        bot.send_message(message.chat.id, 'Ð’Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ!ðŸŽ‰')
        main(message)
    else:
        bot.send_message(message.chat.id, 'Ð’Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ.ðŸ™… ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ.')
        captcha(message)



def main(message):
    button = types.ReplyKeyboardMarkup(resize_keyboard=True)
    button.add(types.KeyboardButton('ðŸ’µÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Bitcoin (BTC)ðŸ’µ'), types.KeyboardButton('ðŸ’·ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ Bitcoin (BTC)ðŸ’·'))
    button.add(types.KeyboardButton('ðŸ’¶ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Bitcoin Ð½Ð° BMB (Ð‘ÐµÐ· ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¸)ðŸ’¶'))
    button.add(types.KeyboardButton('ðŸ‘¨ðŸ¼â€ðŸ’»ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ðŸ‘¨ðŸ¼â€ðŸ’»'), types.KeyboardButton('ðŸ“œÐŸÑ€Ð°Ð²Ð¸Ð»Ð°ðŸ“œ'))

    msg = bot.send_message(message.chat.id, 'Ð’Ð°Ñ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±Ð¼ÐµÐ½Ð½Ð¸Ðº Ð‘Ð Ð˜Ð¡Ð¢ÐžÐ›Ð¬ðŸŒº\n\nÐ£ Ð½Ð°Ñ Ð²Ñ‹ Ð²ÑÐµÐ³Ð´Ð° Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ BTC Ð¿Ð¾ Ð¿Ñ€Ð¸ÑÑ‚Ð½Ð¾Ð¼Ñƒ ÐºÑƒÑ€ÑÑƒðŸ”®ðŸ”®\n\nÐ”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ!',reply_markup=button)
    bot.register_next_step_handler(msg, choice)

def choice(message):

    if message.text == 'ðŸ’µÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Bitcoin (BTC)ðŸ’µ':
        buy_btc(message)
    elif message.text == 'ðŸ’·ÐŸÑ€Ð¾Ð´Ð°Ñ‚ÑŒ Bitcoin (BTC)ðŸ’·':
        finish1(message)
    elif message.text == 'ðŸ’¶ÐšÑƒÐ¿Ð¸Ñ‚ÑŒ Bitcoin Ð½Ð° BMB (Ð‘ÐµÐ· ÐºÐ¾Ð¼Ð¸ÑÑÐ¸Ð¸)ðŸ’¶':
        buy_bmb(message)
    elif message.text == 'ðŸ‘¨ðŸ¼â€ðŸ’»ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ðŸ‘¨ðŸ¼â€ðŸ’»':
        operator(message)
    elif message.text == 'ðŸ“œÐŸÑ€Ð°Ð²Ð¸Ð»Ð°ðŸ“œ':
        rules(message)
    else:
        main(message)

def operator(message):
    bot.send_message(message.chat.id, 'https://t.me/krigelmega')
    main(message)


def rules(message):
    bot.send_message(message.chat.id, 'https://telegra.ph/Pravila-i-soglashenie--Sonic-Ex-10-12')
    main(message)

global price

price = cg.get_price(ids='bitcoin', vs_currencies='rub')

def buy_btc(message):
    button = types.ReplyKeyboardRemove()
    b = types.ReplyKeyboardMarkup(resize_keyboard=True)
    price = cg.get_price(ids='bitcoin', vs_currencies='rub')
    msg = bot.send_message(message.chat.id, f'1 Bitcoin = {int(price["bitcoin"]["rub"] * 1.95)} RUB\n\nÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ : Ð¾Ñ‚ 0.0001 BTC Ð¸Ð»Ð¸ Ð¾Ñ‚ 300 Ñ€ÑƒÐ± ðŸ’¶\n\nÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ:', reply_markup=button)
    bot.register_next_step_handler(msg, proverka)


def buy_bmb(message):
    msg = bot.send_message(message.chat.id,
                           f'1 Bitcoin = {int(price["bitcoin"]["rub"])} RUB\n\nÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ : Ð¾Ñ‚ 0.0001 Ð´Ð¾ 0.5 BTCðŸ’¶\n\nÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ:',
                           reply_markup=button)
    bot.register_next_step_handler(msg, new)
def new(message):
    cource1 = {}
    proverka1 = {}
    proverka1['buy_bmb'] = message.text
    cource1 = float(proverka1["buy_bmb"])
    bot.send_message(ID, f'BMB Ð—ÐÐ¯Ð’ÐšÐ https://web.telegram.org/k/#{message.from_user.id} {cource1}')
    bot.send_message(message.chat.id, f'Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÐ»Ð¸ Ð²Ð°ÑˆÑƒ Ð·Ð°ÑÐ²ÐºÑƒ Ð½Ð° {cource1} BTC. ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°.â³                                                     ')
    main(message)



def nonbtc(message):
    msg = bot.send_message(message.chat.id, 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°')
    buy_btc(message)
def proverka(message):
    try:
        global course
        course = {}
        proverka = {}
        proverka['buy_btc'] = message.text
        course = float(proverka["buy_btc"])
        if (course > 300) and (course < 80000):
            msg = bot.send_message(message.chat.id, f'Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ {float("{0:.8f}".format(course / (price["bitcoin"]["rub"])))} BTC Ð½Ð° Ð²Ð°Ñˆ ÐºÐ¾ÑˆÐµÐ»ÐµÐº.ðŸ’°\n\nÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ BTC Ð°Ð´Ñ€ÐµÑ.\n\nÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÐµÑ‚ÑÑ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ ðŸ’³ Ð±Ð°Ð½ÐºÐ° Ð¢Ð¸Ð½ÑŒÐºÐ¾Ñ„Ñ„ Ð¸Ð»Ð¸ Ð¡Ð±ÐµÑ€Ð±Ð°Ð½Ðº')
            bot.register_next_step_handler(msg, proverka2)
        elif (type(course) == float) and (course > 0.00001) and (course < 0.03):
            msg = bot.send_message(message.chat.id, f'Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ {course} BTC Ð½Ð° Ð²Ð°Ñˆ ÐºÐ¾ÑˆÐµÐ»ÐµÐº.ðŸ’°\n\nÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ BTC Ð°Ð´Ñ€ÐµÑ.')
            bot.register_next_step_handler(msg, proverka3)
        else:

            buy_btc(message)
    except ValueError:

        buy_btc(message)
def proverka2(message):
    global wallet
    wallet = {}
    wallet["proverka"] = message.text
    if (len(str(wallet)) > 24) and (len(str(wallet)) < 80):
        button = types.ReplyKeyboardMarkup(resize_keyboard=True)
        button.add(types.KeyboardButton("ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽâœ…"), types.KeyboardButton('Ð“Ð»Ð°Ð²Ð½Ð°ÑðŸ”™'))

        price = cg.get_price(ids='bitcoin', vs_currencies='rub')
        msg = bot.send_message(message.chat.id, f'Ð’Ñ‹ Ð¾Ð±Ð¼ÐµÐ½Ð¸Ð²Ð°ÐµÑ‚Ðµ {float("{0:.0f}".format(course))} Ð½Ð° {float("{0:.8f}".format(course / (price["bitcoin"]["rub"]) * 1.95))} BTC'
                                          f'\n\nÐ’Ð°Ñˆ ÐºÐ¾ÑˆÐµÐ»ÐµÐº: {wallet["proverka"]}'
                                          f'\n\nÐœÑ‹ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼ Ð¾Ñ‚ Ð²Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ {course} Ð¿Ð¾ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ð°Ð¼: +79140707919', reply_markup=button)
        bot.register_next_step_handler(msg, finish)

    else:
        bot.send_message(message.chat.id, 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°')
        buy_btc(message)

def proverka3(message):
    global wallet1
    wallet1 = {}
    wallet1["proverka3"] = message.text
    if (len(str(wallet1)) > 24) and (len(str(wallet1)) < 80):

        button = types.ReplyKeyboardMarkup(resize_keyboard=True)
        button.add(types.KeyboardButton("ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽâœ…"), types.KeyboardButton('Ð“Ð»Ð°Ð²Ð½Ð°ÑðŸ”™'))

        price = cg.get_price(ids='bitcoin', vs_currencies='rub')
        msg = bot.send_message(message.chat.id, f'Ð’Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚Ðµ {float("{0:.8f}".format(course))} Ð·Ð° {float("{0:.0f}".format(course * ((price["bitcoin"]["rub"]))))*1.97} Ñ€ÑƒÐ±Ð»ÐµÐ¹.'
                                          f'\n\nÐ’Ð°Ñˆ ÐºÐ¾ÑˆÐµÐ»ÐµÐº: {wallet1["proverka3"]}'
                                          f'\n\nÐœÑ‹ Ð¾Ð¶Ð¸Ð´Ð°ÐµÐ¼ Ð¾Ñ‚ Ð²Ð°Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ {float("{0:.0f}".format(course * (price["bitcoin"]["rub"]))) * 1.07} Ð¿Ð¾ Ñ€ÐµÐºÐ²Ð¸Ð·Ð¸Ñ‚Ð°Ð¼: +79140707919', reply_markup=button)
        bot.register_next_step_handler(msg, finish)
        print(course, price)
    else:
        bot.send_message(message.chat.id, 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾ÑˆÐµÐ»ÑŒÐºÐ°')
        buy_btc(message)

def finish(message):
    price = cg.get_price(ids='bitcoin', vs_currencies='rub')
    if message.text == 'ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÑŽâœ…':
        bot.send_message(message.chat.id, 'Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° Ð±Ñ‹Ð»Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð°. ÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ')
        main(message)
        bot.send_message(ID, f'Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð±Ð¼ÐµÐ½Ð°: {course}\n\n'
                                        f'ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {float("{0:.8f}".format(course / (price["bitcoin"]["rub"])))} BTC\n\n'
                                        f'ÐÐ° ÐºÐ¾ÑˆÐµÐ»ÐµÐº: {wallet1["proverka3"]}\n\n'
                                        f'Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°ÑÐ²ÐºÐ¸: {datetime.datetime.now()}', reply_markup=button)
    elif message.text == 'Ð“Ð»Ð°Ð²Ð½Ð°ÑðŸ”™':
        main(message)
        pass

def finish1(message):
    msg = bot.send_message(message.chat.id, "ðŸ«°ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ(Ð¾Ñ‚ 0.00001 BTC), ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð²Ñ‹ Ð¶ÐµÐ»Ð°ÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð°Ñ‚ÑŒ:")
    bot.register_next_step_handler(msg, finish2)

def finish2(message):
    bot.send_message(message.chat.id, "ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¾!\n\nÐžÐ¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°â³")
    bot.send_message(ID, f'https://web.telegram.org/k/#{message.from_user.id}')
    main(message)


bot.polling()
